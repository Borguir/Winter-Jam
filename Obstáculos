extends Area2D

@export_enum("Obstaculo", "Rampa", "Pescao", "Obst_alto") var tipo_objeto: int = 0

var velo_y = 100
var velo_x = 10
var dificultad = 1.0
var direccion_x = 0 
var lado_izq = 80.0 
var lado_der = 100.0
var es_alto = false
var multiplicador_tamano = 1.0

@onready var sprite = $Sprite2D
@onready var colision = $CollisionShape2D

func _ready() -> void:
	if position.x < lado_izq: direccion_x = -1
	elif position.x > lado_der: direccion_x = 1
	
	if tipo_objeto == 3: # ARBOL
		multiplicador_tamano = 3.0
		
	elif tipo_objeto == 2: # PEZ
		multiplicador_tamano = 1.5
	
		if es_alto:
			sprite.position.y = -60
			colision.position.y = -60
	else:
		multiplicador_tamano = 1.5
	actualizar_escala()

func _process(delta: float) -> void:
	var progreso = remap(position.y, 0, 320, 0.1, 1.2) 
	progreso = clamp(progreso, 0.1, 2.0)
	position.y += (velo_y * dificultad * progreso) * delta
	position.x += (velo_x * direccion_x) * dificultad * progreso * delta
	actualizar_escala()
	if position.y > 360:
		queue_free()
	
	if position.y > 260.0:
		colision.disabled = true 

func actualizar_escala():
	var progreso = remap(position.y, 0, 320, 0.1, 1.2) 
	progreso = clamp(progreso, 0.1, 2.0)
	var escala_final = progreso * multiplicador_tamano
	scale = Vector2(escala_final, escala_final)

func _on_body_entered(body):
	if body.is_in_group("Player"): 
		if tipo_objeto == 2:
			if body.haciendo_qte:
				return 
			if es_alto:
				if not body.saltando:
					return
			else:
				if body.saltando:
					return
			recoger_pez() 
			
		elif tipo_objeto == 1:
			if body.saltando: return
			if body.has_method("iniciar_qte"):
				body.iniciar_qte()
				
		elif tipo_objeto == 0: 
			if not body.saltando:
				chocar_jugador()
				
		elif tipo_objeto == 3:
			if body.haciendo_qte: return
			chocar_jugador()

func recoger_pez():
	var main = get_tree().current_scene
	if main.has_method("sumar_puntos"): 
		main.sumar_puntos(50)
	queue_free()

func chocar_jugador():
	var main = get_tree().current_scene
	if main.has_method("choques"): main.choques()
	if main.has_method("restar_puntos"): main.restar_puntos(50)
	queue_free()
